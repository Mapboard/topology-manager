#!/usr/bin/env coffee
{db,sql} = require '../src/util'
colors = require 'colors'

do ->
  await db.none "SET session_replication_role = replica;"
  res = await db.query sql("topology/procedures/get-contacts-to-update")
  await db.none "TRUNCATE TABLE map_topology.__linework_failures"
  for {id} in res
    try
      await db.query sql('topology/procedures/update-contact'), {id}
    catch err
      await db.none sql('topology/procedures/linework-failures'), {id}
      console.error id+"  "+colors.red(err)
  await db.none sql('topology/procedures/update-contact-data')
  await db.none "SET session_replication_role = DEFAULT;"
  process.exit()

