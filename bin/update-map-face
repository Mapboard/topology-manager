#!/usr/bin/env zsh

here=$(dirname "$(readlink -f "$0")")
base=${here:h}

source "$base/defs.sh"

if [ "$1" = '--reset' ]; then
  echo "Resetting map faces"
  psql $dbname -f "$base/topology/procedures/reset-map-face.sql"
fi

psql $dbname -c "REFRESH MATERIALIZED VIEW map_topology.__face_relation"

sql="SELECT count(*) FROM map_topology.__dirty_face"
nfaces=$(psql Naukluft -tA -c $sql)
echo "$nfaces dirty faces"
while [[ $nfaces -ge 0 ]]; do
  psql $dbname -tA -c "SELECT map_topology.update_map_face(false)" > /dev/null
  nfaces=$(psql $dbname -tA -c $sql)
  echo "$nfaces remaining\n"
done

